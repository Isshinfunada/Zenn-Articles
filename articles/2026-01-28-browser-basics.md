---
title: "「作って学ぶブラウザのしくみ」学習記録：HTMLトークナイザーの実装開始"
type: "tech"
emoji: "🌐"
topics:
  - "ブラウザ"
  - "HTML"
  - "Rust"
  - "パーサー"
  - "技術書"
published: true
---
# 今日やったこと

「作って学ぶブラウザのしくみ」の第4章に入り、HTMLからDOMツリーへ変換する実装について学習しました。字句解析（トークナイゼーション）の基礎概念から、Rustでの具体的な実装まで進めました。

# 今日学んだこと

## DOMとは何か

ブラウザはHTML文書をDOMツリーと呼ばれる木構造に変換します。DOMはHTMLの要素とJavaScriptなどのスクリプト言語とのインターフェースをオブジェクトで表現したもので、これによりHTML文書の操作が可能になります。

DOMツリーを構成する各ノードはNodeインターフェースを実装するオブジェクトであり、`firstChild`などのプロパティやメソッドを通じて、要素の作成・削除・変更といった操作をHTML以外のプログラミング言語から行えます。

## 字句解析（トークナイゼーション）

HTMLの実装は大きく分けて以下の2つの処理から成り立ちます：

1. **字句解析**: 文字列を意味のある最小単位（トークン）に分割
2. **構文解析**: 分解された要素の構造や階層関係を解析

今回からは字句解析を実装します。トークンとは文法や意味の解析における基本的な単位で、キーワード、識別子、演算子、文字列、区切り記号などの要素を表します。

## ステートマシンによるトークン化

HTMLの文字列を分割するアルゴリズムはHTML Living Standardで定義されており、ステートマシンとして表現されます。

- **状態（State）**: システムの特定の状態を表す
- **遷移（Transition）**: 状態間の変化や遷移条件を示す

仕様では80種類もの状態が定義されていますが、今回は18種類+TemporaryBufferに絞って実装していきます。これにより開始タグ、終了タグ、文字列などの基本的な処理が可能になります。

## HtmlTokenizer構造体

字句解析に必要な情報を保持する`HtmlTokenizer`構造体を作成しました。以下のフィールドを持ちます：

- `state`: ステートマシンの現在の状態
- `input`: HTML文字列（Vec<char>として保持）
- `pos`: 現在処理している文字の位置
- `reconsume`: 文字を再処理するかのフラグ
- `latest_token`: 最新のトークン
- `buf`: 一時バッファ

## トークンの種類

今回実装した4種類のトークン：

- **StartTag**: 開始タグ（タグ名、self_closingフラグ、属性の配列を持つ）
- **EndTag**: 終了タグ（タグ名を持つ）
- **Char**: 文字
- **Eof**: 入力文字列の終了

DOCTYPEとコメントは今回は実装対象外としました。

## Attribute構造体

タグの属性を表す`Attribute`構造体は、名前（name）と値（value）のフィールドを持ちます。getterメソッドと、フィールドを構築するための`add_char`メソッドを実装しました。

## Iteratorトレイトの実装

Rustの組み込みトレイトである`Iterator`を実装することで、トークンを1つずつ返す機能を導入しました。`next`メソッド内部で状態を管理し、次の状態への遷移を行うステートマシンを実装して、その過程で生成されるトークンを戻り値として返します。

# 次にやること

次回は各データ状態における具体的な処理を実装していく予定です。ステートマシンの18種類の状態それぞれで、どのような処理を行うかを詳細に実装していきます。
