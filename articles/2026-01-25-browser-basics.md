---
title: "「作って学ぶブラウザのしくみ」学習記録：HTTPクライアントの実装を始める"
type: "tech"
emoji: "🌐"
topics:
  - "ブラウザ"
  - "HTTP"
  - "Rust"
  - "技術書"
published: true
---
# 今日やったこと

「作って学ぶブラウザのしくみ」の学習を進め、HTTPクライアントの実装を開始しました。自作OS（Wasabi OS）上で動作するHTTPクライアントを作成するため、標準ライブラリを使わずに独自のライブラリ（`net-wasabi`）を使用する形で実装を進めました。今日はリクエストの送信までを完了し、レスポンスの受信と構築は次回に持ち越しました。

# 今日学んだこと

## プロジェクト構成とCargoフィーチャー機能

- **サブプロジェクトの分離**: 動作させるプラットフォームによって実装を変えるため、`net-wasabi`をライブラリクレートとして作成し、コアプロジェクト（`server-core`）とはディレクトリを分けて管理する構成にしました
- **Cargoのフィーチャー機能**: Rustのプロジェクトで条件付きのコンパイルや依存関係の切り替えを行うためのメカニズム。実行時ではなくコンパイル時に使用するライブラリを決定できます
- **`optional = true`の意味**: この指定がある依存関係はデフォルトではコンパイルに含まれず、フィーチャーが指定された時のみ使用されます
- **デフォルトフィーチャー**: `default = ["wasabi"]`と設定することで、フィーチャー指定なしでも`wasabi`の機能がデフォルトで有効になります

## HTTPクライアントの構造体設計

- **`HTTPClient`構造体**: フィールドを持たないシンプルな構造体として定義
- **`new`関数と`get`メソッド**: `new`関数でインスタンスを生成し、`get`メソッドでGETリクエストを送信する設計
- **`get`メソッドの引数**: ホスト名（String）、ポート番号（u16）、パス名（String）を受け取り、戻り値としてレスポンスの`Result`型を返す

## 名前解決（DNS）の基礎

- **名前解決とは**: ドメイン名からIPアドレスに変換すること。特にドメイン名→IPアドレスの変換を「正引き」、IPアドレス→ドメイン名の変換を「逆引き」と呼びます
- **IPアドレス**: インターネット上でコンピューターやネットワーク機器を識別するための一意の番号。IPv4アドレスは32ビットのデータで、192.0.2.1のような形式で表現されます
- **`lookup_host` API**: Wasabi OSで提供されている、ドメイン名からIPアドレスを取得するためのAPI。1つのドメイン名に対して複数のIPアドレスが見つかる可能性があるため、戻り値はベクターになっています

## ソケットアドレスとTCP接続

- **ソケット**: TCP/IPネットワーク上で通信する際に送信元や送信先を識別するための概念。通常、IPアドレスとポート番号の組み合わせで表されます
- **`SocketAddress`構造体**: IPアドレス構造体とu16で表されるポート番号をフィールドに持つ構造体
- **`connect`メソッド**: TCP接続（コネクション）を確立するためのメソッド。成功すれば`TcpStream`構造体を返し、失敗すればエラーを返す

## HTTPリクエストの構築と送信

- **リクエストライン**: メソッド名、パス名、HTTPバージョンをホワイトスペースでつなげて作成
- **必須ヘッダ**:
  - `Host`: リクエスト先のホストとポート番号を指定（必須）
  - `Connection: close`: レスポンス送信後に接続を切断するよう指定。HTTP/1.1のデフォルト（keep-alive）では接続が維持されるため、シンプルな実装では終端検出のためにこの指定が必要
  - `Accept: text/html`: クライアントが受け入れ可能なコンテンツタイプを指定
- **`write`メソッド**: `TcpStream`構造体のメソッドで、構築したHTTPリクエスト文字列をサーバーに送信

## Rustの文法の復習

- **`impl`（インプリメンテーション）**: 構造体に対してメソッドや関連関数を定義するためのブロック
- **関連関数とメソッドの違い**:
  - 関連関数（Associated Function）: `self`を取らないため、インスタンスを必要としない
  - メソッド: `self`をレシーバーとして受け取るため、インスタンスが必須
- **外部クレートの使用**: `extern crate alloc;`のように宣言して、no_std環境でも外部クレート（ライブラリ）を使用できるようにする

# 次にやること

- HTTPレスポンスの受信処理を実装する
- レスポンスの構築とパースを行う構造体を作成する
- エラー処理の実装を完成させる
