---
title: "「作って学ぶブラウザのしくみ」学習記録： HTTPレスポンスの受信とパース"
type: "tech"
emoji: "🌐"
topics:
  - "ブラウザ"
  - "Rust"
  - "HTTP"
  - "技術書"
published: true
---
# 今日やったこと

「作って学ぶブラウザのしくみ」の学習を進め、HTTPリクエスト送信後の処理として、HTTPレスポンスの受信・パース・構造体への変換までを実装しました。TCPストリームからのデータ読み込み、レスポンス文字列の前処理、そして構造化されたHTTPレスポンスオブジェクトの構築という一連の流れを学びました。

# 今日学んだこと

## TCPストリームからのレスポンス受信

HTTPリクエストを送信した後、レスポンスを受け取る処理を実装しました。

- **リードメソッドでの受信**: TCPストリームのリードメソッドを使用してレスポンスを受信する
- **ループ処理の必要性**: レスポンスが長い場合、サーバーはレスポンスを分割して返すため、ストリームから読み込むバイトがなくなるまでループ処理を回す必要がある
- **バイト列の結合**: 分割されたレスポンスは `extend_from_slice` メソッドで結合する
- **UTF-8変換**: 受信したバイト列はUTF-8関数を使用して文字列型に変換する

## HTTPレスポンス構造体の設計

HTTPレスポンスを表現する構造体を `saba_core` ディレクトリに配置し、どのプラットフォームでも共通で利用できるように設計しました。

構造体には以下のフィールドを含めます：
- **バージョン**: HTTPバージョンを表す文字列
- **ステータスコード**: u32型の数値（200、404など）
- **理由フレーズ**: HTTPステータスコードの説明や意味を表す文字列
- **ヘッダー**: Header構造体のベクター
- **ボディ**: レスポンスボディの文字列

また、Header構造体はヘッダーの名前と対応する値をフィールドに持ちます。

## エラーハンドリングの設計

文字列が不正な場合に備えて、コンストラクターが `Result` 型を返すように設計しました。

- コンストラクターは `Result<Self, Error>` を返す
- 文字列が適切な場合は `Ok` 型でHTTPレスポンスを返す
- エラーの場合は `Err` 型でエラー列挙型を返す
- エラー列挙型は `saba_core::error` に実装し、今後ブラウザの実装の様々な箇所で利用する

`#[derive(Debug, Clone, PartialEq, Eq)]` マクロを使用して、デバッグ出力や比較演算子が使えるようにしました。`PartialEq` と `Eq` の違いとして、`PartialEq` は比較演算子を使えるようにするもので、`Eq` は `PartialEq` に加えて反射律（a == a）を保証するものです。

## レスポンス文字列の前処理

TCPストリームから受け取った文字列から構造化されたHTTPレスポンスオブジェクトを構築するために、まず前処理を行います。

- **先頭の空白除去**: `trim_start()` でレスポンスの文字列から最初の文字が出てくるまでの空白文字を除去
- **改行の統一**: キャリッジリターン改行シーケンス（`\r\n`）を単一の改行（`\n`）に置き換える

OSによって改行文字が異なります。Windowsでは `\r\n`（キャリッジリターン + ラインフィード）、Unix系では `\n`（ラインフィードのみ）が使われます。この違いを前処理で統一することで、後続の処理を簡潔にします。

## レスポンスの分割処理

前処理されたレスポンスを各パーツに分割します。

1. **ステータスラインの分離**: 最初の改行で分割し、分割前の部分をステータスライン、分割後の部分をリメイニングとする。改行が見つからない場合は無効なレスポンス形式としてエラーを返す
2. **ヘッダーとボディの分割**: リメイニングを2つの連続した改行（`\n\n`）で分割。分割が成功すれば前半がヘッダー、後半がボディ。1つの改行しか見つからない場合はヘッダーが存在しないものと仮定し、ヘッダーを空のベクトル、ボディを残りの文字列に設定
3. **ヘッダーのパース**: ヘッダー部分を改行で分割し、各行を `:` で分割してキーと値のペアを作成し、Header構造体のベクターに追加
4. **ステータスラインのパース**: ステータスラインをスペースで分割し、バージョン、ステータスコード、理由フレーズを取り出して構造体にセット

## getメソッドの追加

HTTPレスポンス構造体のフィールドはプライベートなので、他のモジュールからフィールド情報を取得できるようにgetメソッドを追加しました。

- `version()`: バージョンを返す
- `status_code()`: ステータスコードを返す
- `headers()`: ヘッダーのベクターのクローンを返す
- `body()`: ボディのクローンを返す
- `header(name)`: 指定した名前のヘッダー値を返す（Result<String, String>型）

# 次にやること

- ユニットテストを組んで、HTTPレスポンスのパース処理が正しく動作することを確認する
- ユニットテストが通れば、いよいよOS上でプログラムを動かせるようになる
